<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="conteneur">
        <h1>Puissance 4</h1>
        
    <div id="statut" class="statut">
            {{if .PartieTerminee}}
                {{if .Gagnant}}
                    <span class="victoire">Joueur {{.Gagnant}} a gagne !</span>
                {{else}}
                    <span class="nul">Match nul !</span>
                {{end}}
            {{else}}
                <span>Tour du Joueur {{.JoueurActuel}}</span>
            {{end}}
        </div>

        {{if .ModePouvoirs}}
        <div class="pouvoirs-container">
            <div class="pouvoirs-joueur {{if eq .JoueurActuel 1}}actif{{end}}">
                <h3>Joueur 1</h3>
                <div class="pouvoir-item">Bombe: {{index .PouvoisJ1 1}}</div>
                <div class="pouvoir-item">Double: {{index .PouvoisJ1 2}}</div>
                <div class="pouvoir-item">Annulation: {{index .PouvoisJ1 3}}</div>
            </div>
            <div class="pouvoirs-joueur {{if eq .JoueurActuel 2}}actif{{end}}">
                <h3>Joueur 2</h3>
                <div class="pouvoir-item">Bombe: {{index .PouvoisJ2 1}}</div>
                <div class="pouvoir-item">Double: {{index .PouvoisJ2 2}}</div>
                <div class="pouvoir-item">Annulation: {{index .PouvoisJ2 3}}</div>
            </div>
        </div>
        {{end}}

    <div id="plateau" class="plateau">
            {{range $ligneIdx, $ligne := .Plateau}}
                <div class="ligne">
                    {{range $colIdx, $valeur := $ligne}}
                        <div class="cellule 
                            {{if eq $valeur 1}}joueur1
                            {{else if eq $valeur 2}}joueur2
                            {{end}}">
                        </div>
                    {{end}}
                </div>
            {{end}}
        </div>

        {{if not .PartieTerminee}}
        <div id="boutons-colonnes" class="boutons-colonnes">
            {{range $i := Sequence 7}}
            <form method="POST" action="/deposer" class="formulaire-colonne">
                <input type="hidden" name="colonne" value="{{$i}}">
                <button type="submit" class="bouton-colonne">↓</button>
            </form>
            {{end}}
        </div>

        {{if .ModePouvoirs}}
        <div class="pouvoirs-actions">
            <h3>Utiliser un pouvoir :</h3>
            
            <div class="pouvoir-controls">
                <div class="pouvoir-section">
                    <label>Bombe (détruit zone 3x3)</label>
                    <div class="pouvoir-inputs">
                        <input type="number" id="colonneBombe" min="0" max="6" placeholder="Colonne">
                        <button onclick="utiliserPouvoir(1)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>

                <div class="pouvoir-section">
                    <label>Double pion</label>
                    <div class="pouvoir-inputs">
                        <input type="number" id="colonneDouble" min="0" max="6" placeholder="Colonne">
                        <button onclick="utiliserPouvoir(2)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>

                <div class="pouvoir-section">
                    <label>Annulation (2 derniers coups)</label>
                    <div class="pouvoir-inputs">
                        <button onclick="utiliserPouvoir(3)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>
            </div>

            <form id="pouvoirForm" method="POST" action="/pouvoir" style="display: none;">
                <input type="hidden" name="pouvoir" id="pouvoirType">
                <input type="hidden" name="colonne" id="pouvoirColonne">
            </form>

            <script>
                function utiliserPouvoir(type) {
                    let colonne = '';
                    if (type === 1) {
                        colonne = document.getElementById('colonneBombe').value;
                    } else if (type === 2) {
                        colonne = document.getElementById('colonneDouble').value;
                    }
                    
                    if ((type === 1 || type === 2) && !colonne) {
                        alert('Veuillez choisir une colonne');
                        return;
                    }
                    
                    document.getElementById('pouvoirType').value = type;
                    document.getElementById('pouvoirColonne').value = colonne;
                    document.getElementById('pouvoirForm').submit();
                }
            </script>
        </div>
        {{end}}
        {{end}}

        <div class="boutons-actions">
            <form id="formReinit" method="POST" action="/reinitialiser" style="display: inline;">
                <button type="submit" class="bouton-reinitialiser">Nouvelle Partie</button>
            </form>
            
            <form id="formMenu" method="POST" action="/menu" style="display: inline;">
                <button type="submit" class="bouton-menu">Retour au Menu</button>
            </form>
        </div>
    
    <script>
        // Helper pour re-render le plateau et le statut à partir de l'état renvoyé par l'API
        function renderState(state) {
            // statut
            const statutEl = document.getElementById('statut');
            if (state.partieTerminee) {
                if (state.gagnant) {
                    statutEl.innerHTML = `<span class="victoire">Joueur ${state.gagnant} a gagne !</span>`;
                } else {
                    statutEl.innerHTML = `<span class="nul">Match nul !</span>`;
                }
            } else {
                statutEl.innerHTML = `<span>Tour du Joueur ${state.joueurActuel}</span>`;
            }

            // plateau
            const plateauEl = document.getElementById('plateau');
            let html = '';
            for (let i = 0; i < state.plateau.length; i++) {
                html += '<div class="ligne">';
                for (let j = 0; j < state.plateau[i].length; j++) {
                    const val = state.plateau[i][j];
                    let classes = 'cellule ';
                    if (val === 1) classes += 'joueur1';
                    else if (val === 2) classes += 'joueur2';
                    html += `<div class="${classes}"></div>`;
                }
                html += '</div>';
            }
            plateauEl.innerHTML = html;

            // désactiver boutons si partie terminée
            const forms = document.querySelectorAll('.formulaire-colonne');
            forms.forEach(f => {
                const btn = f.querySelector('button');
                if (state.partieTerminee) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
        }

        // Interception des formulaires de colonnes pour envoyer via fetch
        document.querySelectorAll('.formulaire-colonne').forEach(f => {
            f.addEventListener('submit', function(e) {
                e.preventDefault();
                const col = parseInt(f.querySelector('input[name="colonne"]').value, 10);
                fetch('/api/deposer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ colonne: col })
                }).then(r => r.json()).then(state => {
                    renderState(state);
                }).catch(err => console.error(err));
            });
        });

        // Interception réinitialiser pour utiliser l'API (évite reload)
        document.getElementById('formReinit').addEventListener('submit', function(e) {
            e.preventDefault();
            fetch('/api/reinitialiser', { method: 'POST' }).then(r => r.json()).then(state => {
                renderState(state);
            }).catch(err => console.error(err));
        });

        // Retour au menu : laisser le comportement par défaut (redirige vers /)
    </script>
    </div>
</body>
</html>