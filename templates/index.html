<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="conteneur">
        <h1>Puissance 4</h1>
        
        <div class="statut" id="statut">
            {{if .PartieTerminee}}
                {{if .Gagnant}}
                    {{if and .ModeIA (eq .Gagnant 2)}}
                        <span class="victoire">IA a gagn√© !</span>
                    {{else if and .ModeIA (eq .Gagnant 1)}}
                        <span class="victoire">Vous avez gagn√© !</span>
                    {{else}}
                        <span class="victoire">Joueur {{.Gagnant}} a gagn√© !</span>
                    {{end}}
                {{else}}
                    <span class="nul">Match nul !</span>
                {{end}}
            {{else}}
                {{if and .ModeIA (eq .JoueurActuel 2)}}
                    <span>Tour de l'IA...</span>
                {{else if .ModeIA}}
                    <span>Votre tour</span>
                {{else}}
                    <span>Tour du Joueur {{.JoueurActuel}}</span>
                {{end}}
            {{end}}
        </div>

        {{if .ModePouvoirs}}
        <div class="pouvoirs-container">
            <div class="pouvoirs-joueur {{if eq .JoueurActuel 1}}actif{{end}}" id="pouvoirs-j1">
                <h3>{{if .ModeIA}}Vous{{else}}Joueur 1{{end}}</h3>
                <div class="pouvoir-item">üí£ Bombe: <span id="bombe-j1">{{index .PouvoisJ1 1}}</span></div>
                <div class="pouvoir-item">‚ö° Double: <span id="double-j1">{{index .PouvoisJ1 2}}</span></div>
                <div class="pouvoir-item">‚Ü©Ô∏è Annulation: <span id="annul-j1">{{index .PouvoisJ1 3}}</span></div>
            </div>
            <div class="pouvoirs-joueur {{if eq .JoueurActuel 2}}actif{{end}}" id="pouvoirs-j2">
                <h3>{{if .ModeIA}}IA{{else}}Joueur 2{{end}}</h3>
                <div class="pouvoir-item">üí£ Bombe: <span id="bombe-j2">{{index .PouvoisJ2 1}}</span></div>
                <div class="pouvoir-item">‚ö° Double: <span id="double-j2">{{index .PouvoisJ2 2}}</span></div>
                <div class="pouvoir-item">‚Ü©Ô∏è Annulation: <span id="annul-j2">{{index .PouvoisJ2 3}}</span></div>
            </div>
        </div>
        {{end}}

        <div class="plateau" id="plateau">
            {{range $ligneIdx, $ligne := .Plateau}}
                <div class="ligne">
                    {{range $colIdx, $valeur := $ligne}}
                        <div class="cellule 
                            {{if eq $valeur 1}}joueur1
                            {{else if eq $valeur 2}}joueur2
                            {{end}}" data-ligne="{{$ligneIdx}}" data-col="{{$colIdx}}">
                        </div>
                    {{end}}
                </div>
            {{end}}
        </div>

        {{if not .PartieTerminee}}
        <div class="boutons-colonnes">
            {{range $i := Sequence 7}}
            <button type="button" class="bouton-colonne" onclick="jouerCoup({{$i}})">‚Üì</button>
            {{end}}
        </div>

        {{if .ModePouvoirs}}
        <div class="pouvoirs-actions">
            <h3>Utiliser un pouvoir :</h3>
            
            <div class="pouvoir-controls">
                <div class="pouvoir-section">
                    <label>Bombe (d√©truit zone 3x3)</label>
                    <div class="pouvoir-inputs">
                        <input type="number" id="colonneBombe" min="0" max="6" placeholder="Colonne">
                        <button onclick="utiliserPouvoir(1)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>

                <div class="pouvoir-section">
                    <label>Double pion</label>
                    <div class="pouvoir-inputs">
                        <input type="number" id="colonneDouble" min="0" max="6" placeholder="Colonne">
                        <button onclick="utiliserPouvoir(2)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>

                <div class="pouvoir-section">
                    <label>Annulation (2 derniers coups)</label>
                    <div class="pouvoir-inputs">
                        <button onclick="utiliserPouvoir(3)" class="bouton-pouvoir">Utiliser</button>
                    </div>
                </div>
            </div>

            <form id="pouvoirForm" method="POST" action="/pouvoir" style="display: none;">
                <input type="hidden" name="pouvoir" id="pouvoirType">
                <input type="hidden" name="colonne" id="pouvoirColonne">
            </form>
        </div>
        {{end}}
        {{end}}

        <div class="boutons-actions">
            <form method="POST" action="/reinitialiser" style="display: inline;">
                <button type="submit" class="bouton-reinitialiser">Nouvelle Partie</button>
            </form>
            
            <form method="POST" action="/menu" style="display: inline;">
                <button type="submit" class="bouton-menu">Retour au Menu</button>
            </form>
        </div>
    </div>

    <script>
        const modeIA = {{.ModeIA}};
        const modePouvoirs = {{.ModePouvoirs}};
        let partieTerminee = {{.PartieTerminee}};

        async function jouerCoup(colonne) {
            if (partieTerminee) return;

            try {
                const formData = new FormData();
                formData.append('colonne', colonne);

                const response = await fetch('/api/deposer', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    mettreAJourPlateau(data.plateau);
                    mettreAJourStatut(data);
                    
                    if (modePouvoirs) {
                        mettreAJourPouvoirs(data);
                    }
                    
                    partieTerminee = data.partieTerminee;
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function mettreAJourPlateau(plateau) {
            const cellules = document.querySelectorAll('.cellule');
            let index = 0;
            
            for (let ligne = 0; ligne < 6; ligne++) {
                for (let col = 0; col < 7; col++) {
                    const cellule = cellules[index];
                    cellule.className = 'cellule';
                    
                    if (plateau[ligne][col] === 1) {
                        cellule.classList.add('joueur1');
                    } else if (plateau[ligne][col] === 2) {
                        cellule.classList.add('joueur2');
                    }
                    
                    index++;
                }
            }
        }

        function mettreAJourStatut(data) {
            const statut = document.getElementById('statut');
            
            if (data.partieTerminee) {
                if (data.gagnant) {
                    if (modeIA && data.gagnant === 2) {
                        statut.innerHTML = '<span class="victoire">IA a gagn√© !</span>';
                    } else if (modeIA && data.gagnant === 1) {
                        statut.innerHTML = '<span class="victoire">Vous avez gagn√© !</span>';
                    } else {
                        statut.innerHTML = `<span class="victoire">Joueur ${data.gagnant} a gagn√© !</span>`;
                    }
                } else {
                    statut.innerHTML = '<span class="nul">Match nul !</span>';
                }
            } else {
                if (modeIA && data.joueurActuel === 2) {
                    statut.innerHTML = '<span>Tour de l\'IA...</span>';
                } else if (modeIA) {
                    statut.innerHTML = '<span>Votre tour</span>';
                } else {
                    statut.innerHTML = `<span>Tour du Joueur ${data.joueurActuel}</span>`;
                }
            }
        }

        function mettreAJourPouvoirs(data) {
            if (data.pouvoisJ1) {
                document.getElementById('bombe-j1').textContent = data.pouvoisJ1[1] || 0;
                document.getElementById('double-j1').textContent = data.pouvoisJ1[2] || 0;
                document.getElementById('annul-j1').textContent = data.pouvoisJ1[3] || 0;
            }
            
            if (data.pouvoisJ2) {
                document.getElementById('bombe-j2').textContent = data.pouvoisJ2[1] || 0;
                document.getElementById('double-j2').textContent = data.pouvoisJ2[2] || 0;
                document.getElementById('annul-j2').textContent = data.pouvoisJ2[3] || 0;
            }

            // Mettre √† jour les classes actif
            const pouvoirsJ1 = document.getElementById('pouvoirs-j1');
            const pouvoirsJ2 = document.getElementById('pouvoirs-j2');
            
            if (data.joueurActuel === 1) {
                pouvoirsJ1.classList.add('actif');
                pouvoirsJ2.classList.remove('actif');
            } else {
                pouvoirsJ1.classList.remove('actif');
                pouvoirsJ2.classList.add('actif');
            }
        }

        function utiliserPouvoir(type) {
            let colonne = '';
            if (type === 1) {
                colonne = document.getElementById('colonneBombe').value;
            } else if (type === 2) {
                colonne = document.getElementById('colonneDouble').value;
            }
            
            if ((type === 1 || type === 2) && !colonne) {
                alert('Veuillez choisir une colonne');
                return;
            }
            
            document.getElementById('pouvoirType').value = type;
            document.getElementById('pouvoirColonne').value = colonne;
            document.getElementById('pouvoirForm').submit();
        }
    </script>
</body>
</html>